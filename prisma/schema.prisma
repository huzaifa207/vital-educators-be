// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x", "debian-openssl-1.1.x", "linux-musl", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                       Int               @id @default(autoincrement())
  first_name               String
  last_name                String
  email                    String            @unique
  password                 String
  profile_url              String            @default("")
  address_1                String
  address_2                String            @default("")
  phone                    String?
  country                  String
  postal_code              String
  search_visibility        Boolean?          @default(false)
  promotion_vital_educator Boolean?          @default(false)
  promotion_third_parties  Boolean?          @default(false)
  email_approved           Boolean?          @default(false)
  email_token              String?           @unique
  password_reset_token     Int?              @unique
  createdAt                DateTime?         @default(now())
  updatedAt                DateTime?         @updatedAt
  role                     Role              @default(STUDENT)
  tutor                    Tutor?
  student                  Student?
  notifications            Notification[]
  block_status             Boolean           @default(false)
  block_reason             String?           @default("")
  flaggedMessagesReceived  FlaggedMessage[]  @relation("SentTo")
  flaggedMessagesSent      FlaggedMessage[]  @relation("SentBy")
  subscription             Subscription?
  subscriptionId           Int?              @unique
  StudentPayment           StudentPayment?
  purchases                StudentPurchase[]
}

model whitelist {
  id        Int
  token     String    @id @unique
  createdAt DateTime? @default(now())
}

model Student {
  id        Int        @id @default(autoincrement())
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    Int        @unique
  feedbacks Feedback[]
}

model Conversation {
  id         Int       @id @default(autoincrement())
  status     String
  tutorId    Int
  studentId  Int
  tutorReply Boolean   @default(false)
  createdAt  DateTime? @default(now())
  updatedAt  DateTime? @updatedAt
}

model Chats {
  id         Int       @id @default(autoincrement())
  message    String
  senderId   Int
  receiverId Int
  seen       Boolean   @default(false)
  createdAt  DateTime? @default(now())
  updatedAt  DateTime? @updatedAt
}

model Tutor {
  id                                 Int             @id @default(autoincrement())
  crb_check                          Boolean         @default(false)
  skype_id                           String          @default("")
  deActivate                         Boolean         @default(false)
  createdAt                          DateTime?       @default(now())
  updatedAt                          DateTime?       @updatedAt
  user                               User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId                             Int             @unique
  referees                           Referees[]
  qualification                      Qualification[]
  tutoringDetail                     TutoringDetail?
  subjectOffers                      SubjectOffer[]
  documents                          Documents?
  is_account_approved                ApprovalStatus  @default(PENDING)
  is_profile_pic_approved            ApprovalStatus  @default(NOT_ADDED)
  is_government_document_approved    ApprovalStatus  @default(NOT_ADDED)
  is_qualification_document_approved ApprovalStatus  @default(NOT_ADDED)
  is_referee_approved                ApprovalStatus  @default(NOT_ADDED)
  feedbacks                          Feedback[]
}

model Feedback {
  id            Int       @id @default(autoincrement())
  rating        Int
  comment       String
  comment_reply String    @default("")
  createdAt     DateTime? @default(now())
  updatedAt     DateTime? @updatedAt
  Tutor         Tutor     @relation(fields: [tutorId], references: [id])
  tutorId       Int
  Student       Student   @relation(fields: [studentId], references: [id])
  studentId     Int
}

enum StripePlan {
  NONE
  BASE
}

enum SubscriptionStatus {
  ACTIVE
  INACTIVE
}

model StudentPayment {
  user       User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId     Int               @unique
  customerId String            @default("")
  credits    Int               @default(0)
  purchases  StudentPurchase[]
}

enum PurchaseMethod {
  Credit
  Stripe
}

enum PurchaseStatus {
  Active
  Deleted
  Suspended
}

enum DisputeStatus {
  Open
  Closed
}

model PurchaseDispute {
  id               Int             @id @default(autoincrement())
  purchase         StudentPurchase @relation(fields: [purchaseId], references: [id], onDelete: Cascade)
  purchaseId       Int
  status           DisputeStatus   @default(Open)
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @default(now())
  openDescription  String          @default("")
  closeDescription String          @default("")
}

model StudentPurchase {
  id              Int               @id @default(autoincrement())
  tutor           User              @relation(fields: [tutorId], references: [id], onDelete: Cascade)
  tutorId         Int
  user            StudentPayment    @relation(fields: [userId], references: [userId], onDelete: Cascade)
  userId          Int
  method          PurchaseMethod
  status          PurchaseStatus    @default(Active)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @default(now())
  purchaseDispute PurchaseDispute[]
}

model Subscription {
  id Int @id @default(autoincrement())

  customerId           String             @unique
  plan                 StripePlan         @default(NONE)
  subscriptionId       String
  status               SubscriptionStatus @default(INACTIVE)
  user                 User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId               Int                @unique
  paymentMethodId      String             @default("")
  last4                String             @default("")
  brand                String             @default("")
  exp_month            Int                @default(0)
  exp_year             Int                @default(0)
  last_attempt_success Boolean            @default(true)
  started              Int                @default(0)
  end                  Int                @default(0)
  cancelled            Boolean            @default(false)
  // client_secret: string
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @default(now())
}

model Referees {
  id              Int              @id @default(autoincrement())
  first_name      String
  last_name       String
  email           String           @unique
  phone           String
  relation        RelationType     @default(OTHER)
  tutor           Tutor            @relation(fields: [tutorId], references: [id], onDelete: Cascade)
  tutorId         Int
  RefereesReviews RefereesReviews?
}

model RefereesReviews {
  referees               Referees @relation(fields: [refereeId], references: [id], onDelete: Cascade)
  refereeId              Int      @unique
  reliability_rating     Int
  trust_rating           Int
  professionalism_rating Int
  description            String
}

model Qualification {
  id                 Int    @id @default(autoincrement())
  degree_title       String
  level              String
  institute          String
  year_of_completion Int
  document           String
  tutor              Tutor  @relation(fields: [tutorId], references: [id], onDelete: Cascade)
  tutorId            Int
}

model TutoringDetail {
  id                  Int      @id @default(autoincrement())
  about               String
  year_of_experience  Int
  teaching_experience String
  approach            String
  availability        String[]
  languages           String[]
  tutor               Tutor    @relation(fields: [tutorId], references: [id], onDelete: Cascade)
  tutorId             Int      @unique
}

model SubjectOffer {
  id                Int     @id @default(autoincrement())
  title             String
  primary           Int     @default(0)
  secondary         Int     @default(0)
  gsce              Int     @default(0)
  higher_education  Int     @default(0)
  casual_learner    Int     @default(0)
  a_level           Int     @default(0)
  online_discount   Int     @default(0)
  first_free_lesson Boolean @default(false)
  in_person         Boolean @default(true)
  online            Boolean @default(true)
  tutor             Tutor   @relation(fields: [tutorId], references: [id], onDelete: Cascade)
  tutorId           Int
}

model Documents {
  id                      Int    @id @default(autoincrement())
  passport_url            String @default("")
  license_url             String @default("")
  criminal_record_url     String @default("")
  tutor                   Tutor  @relation(fields: [tutorId], references: [id], onDelete: Cascade)
  tutorId                 Int    @unique
}

model Media {
  id       Int      @id @default(autoincrement())
  key      String
  link     String?
  fileType FileType @default(MEDIA)
}

model Alert {
  id          Int       @id @default(autoincrement())
  description String
  actionURL   String
  createdAt   DateTime? @default(now())
  isArchived  Boolean?  @default(false)
}

model Notification {
  id          Int                    @id @default(autoincrement())
  title       String
  description String
  targetType  NotificationTargetType
  target      User?                  @relation(fields: [targetId], references: [id])
  targetId    Int?
  role        NotificationRole?
  createdAt   DateTime?              @default(now())
  updatedAt   DateTime?              @default(now())
  isArchived  Boolean?               @default(false)
}

model FlaggedMessage {
  id      Int    @id @default(autoincrement())
  message String

  sentBy   User @relation(name: "SentBy", fields: [sentById], references: [id])
  sentById Int

  sentTo   User @relation(name: "SentTo", fields: [sentToId], references: [id])
  sentToId Int

  createdAt  DateTime? @default(now())
  updatedAt  DateTime? @default(now())
  isArchived Boolean?  @default(false)
}

model Resources {
  id            Int     @id @default(autoincrement())
  subject       String
  level         String
  type          String
  revisionType  String?
  title         String
  link          String?
  resourceS3Key String?
  fileType      String  @default("URL")
  slug          String
}

model Subscriptions {
  id            Int     @id @default(autoincrement())
  email         String  @unique
  subscribed    Boolean @default(true)
  source        String  @default("free-resources")
}

enum FileType {
  RESOURCE
  DOCUMENT
  MEDIA
}

enum NotificationTargetType {
  GLOBAL
  USER
}

enum NotificationRole {
  STUDENT
  TUTOR
  ALL
}

enum Role {
  STUDENT
  TUTOR
  ADMIN
}

enum RelationType {
  FRIEND
  TEACHER
  COLLEAGE
  CLIENT
  EMPLOYER
  OTHER
}

enum Availability {
  WEEKENDS
  WEEKDAYS
  EVENING
  MORNINIG
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
  NOT_ADDED
}
